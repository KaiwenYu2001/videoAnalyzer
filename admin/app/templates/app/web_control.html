{% extends "app/base_site.html" %}

{% block title %} 视频流管理 {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
{% endblock stylesheets %}

{% block content %}

  <div class="right_col" role="main">
    <div class="">
      <div class="row">

      <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>后台算法管理
            <span id="top_loading" ><img class="top_loading_img" src="/static/images/load.gif" alt="loading">加载中</span>
            <span id="top_msg"></span>
          </h2>

        <div class="pull-right" >
          <button type="button" onclick="reload()"  class="btn btn-success btn-sm">刷新</button>
        </div>

        <div class="pull-right" >
            <button type="button" onclick="loadAlgorithm()"  class="btn btn-success btn-sm">加载算法</button>
          </div>

          <div class="clearfix"></div>
        </div>

        <div class="x_content">
        <!--<p><code>msg</code></p>-->

          <div class="table-responsive">
            <table class="table table-striped jambo_table bulk_action">
              <thead>
                <tr class="headings">
                  <th class="column-title"># </th>
                  <th class="column-title">来源 </th>
                  <th class="column-title">视频流 </th>
                  <th class="column-title">状态 </th>
                  <th class="column-title">在线人数 </th>
                  <th class="column-title">入口带宽 </th>
                  <th class="column-title">视频信息 </th>
                  <th class="column-title">音频信息 </th>
                  <th class="column-title last"><span class="nobr">操作</span>
                  </th>
                </tr>
              </thead>

              <tbody id="data">
              </tbody>
            </table>
          </div>


        </div>
      </div>
    </div>

      </div>
    </div>
  </div>

{% endblock content %}

{% block javascripts %}
  {{ block.super }}

<script>

    let eleData = $("#data");
    let ele_top_loading = $("#top_loading");
    let ele_top_msg= $("#top_msg");

    function reload(){
        window.location.reload();
    }
    
    function getData() {
        ele_top_loading.show();
        $.ajax({
               url: '/api/getStreams',
               type: "get",
               async: true,
               data: {},
               dataType: "json",
               timeout: 0,
               error: function () {
                   ele_top_loading.hide();
                   myAlert("网络异常，请确定网络正常！","error",3000);
               },
               success: function (res) {
                   ele_top_loading.hide();
                   let medisServerState = res.medisServerState;
                   let mediaServerState_msg = res.mediaServerState_msg;

                   ele_top_msg.html(mediaServerState_msg);

                   if(1000 === res.code){
                       eleData.html("");
                       let data = res.data;
                       let data_length = data.length;

                       let item_html = "";

                       if(0===data_length){
                          item_html += "<tr class=\"even pointer\"><td colspan='9'>暂无数据</td></tr>";
                       }
                       else{
                            for (let i = 0; i < data_length; i++) {
                               let d = data[i];
                               item_html += "<tr class=\"even pointer\">";
                               item_html += "<td>"+i.toString()+"</td>";
                               item_html += "<td>"+d["ori"]+"</td>";
                               item_html += "<td>"+d["app"]+"/"+d["name"]+"</td>";
                               if(d["active"]){
                                   item_html += "<td><span class='sun-state-success'>在线</span></td>";
                               }else{
                                   item_html += "<td><span class='sun-state-error'>离线</span></td>";
                                }
                               item_html += "<td>"+d["clients"]+"</td>";
                               item_html += "<td>"+d["produce_speed"]+"</td>";
                               item_html += "<td>"+d["video"]+"</td>";
                               item_html += "<td>"+d["audio"]+"</td>";
                               item_html += "<td><a class='sun-a-label'  href=\"/player?app="+d["app"]+"&name="+d["name"]+"\" >预览</a></td>";
                               item_html += "</tr>";
                           }
                        }
                        eleData.append(item_html);

                        //setTimeout(function () {getData();}, 6000);

                   }else{
                        myAlert(res.msg,"error",6000);
                   }
               }
            });

    }

    function loadAlgorithm() {
        ele_top_loading.show();
        $.ajax({
               url: 'api/runAlgorithm',
               type: "get",
               async: true,
               data: {},
               dataType: "json",
               timeout: 0,
               error: function () {
                   ele_top_loading.hide();
                   myAlert("网络异常，请确定网络正常！","error",3000);
               },
               success: function (res) {
                   ele_top_loading.hide();
                   let medisServerState = res.medisServerState;
                   let mediaServerState_msg = res.mediaServerState_msg;

                   ele_top_msg.html(mediaServerState_msg);

                   if(1000 === res.code){
                       eleData.html("");
                       let data = res.data;
                       let data_length = data.length;

                       let item_html = "";

                       if(0===data_length){
                          item_html += "<tr class=\"even pointer\"><td colspan='9'>暂无数据</td></tr>";
                       }
                       else{
                            for (let i = 0; i < data_length; i++) {
                               let d = data[i];
                               item_html += "<tr class=\"even pointer\">";
                               item_html += "<td>"+i.toString()+"</td>";
                               item_html += "<td>"+d["ori"]+"</td>";
                               item_html += "<td>"+d["app"]+"/"+d["name"]+"</td>";
                               if(d["active"]){
                                   item_html += "<td><span class='sun-state-success'>在线</span></td>";
                               }else{
                                   item_html += "<td><span class='sun-state-error'>离线</span></td>";
                                }
                               item_html += "<td>"+d["clients"]+"</td>";
                               item_html += "<td>"+d["produce_speed"]+"</td>";
                               item_html += "<td>"+d["video"]+"</td>";
                               item_html += "<td>"+d["audio"]+"</td>";
                               item_html += "<td><a class='sun-a-label'  href=\"/player?app="+d["app"]+"&name="+d["name"]+"\" >预览</a></td>";
                               item_html += "</tr>";
                           }
                        }
                        eleData.append(item_html);

                        //setTimeout(function () {getData();}, 6000);

                   }else{
                        myAlert(res.msg,"error",6000);
                   }
               }
            });

    }

    function f_postHandleControl() {
        streamCode = eleSelectStream.val().trim();//typeof string
        if(streamCode==="-1"){
            myAlert("暂无视频流","error");
            return;
        }else if(streamCode==="0"){
            myAlert("请选择视频流","error");
            return;
        }
        algorithmCode = eleSelectBehavior.val().trim();//typeof string
        if(algorithmCode==="0"){
            myAlert("请选择算法","error");
            return;
        }
        objectCode = eleSelectObject.val().trim();//typeof string
        if(objectCode==="0"){
            myAlert("请选择目标","error");
            return;
        }
        let minInterval = parseInt(ele_min_interval.val());
        if(isNaN(minInterval)){
            myAlert("报警间隔时间不能为空","error");
            return;
        }
        if(minInterval<180){
            myAlert("报警间隔时间不能小于180秒","error");
            return;
        }

        let classThresh = parseFloat(ele_class_thresh.val());
        console.log(typeof classThresh,classThresh)

        if(isNaN(classThresh)){
            myAlert("分类阈值不能为空","error");
            return;
        }

        if(classThresh<=0){
            myAlert("分类阈值不能小于等于0","error");
            return;
        }
        if(classThresh>1){
            myAlert("分类阈值不能大于1","error");
            return;
        }

        let overlapThresh = parseFloat(ele_overlap_thresh.val());

        if(isNaN(overlapThresh)){
            myAlert("IOU阈值不能为空","error");
            return;
        }

        if(overlapThresh<=0){
            myAlert("IOU阈值不能小于等于0","error");
            return;
        }
        if(overlapThresh>1){
            myAlert("IOU阈值不能大于1","error");
            return;
        }

        let remark = ele_remark.val().trim();

        if(polygon_lineArray.length!==polygon_lineMaxCount){
            myAlert("请绘制算法识别区域","error");
            return;
        }
        let video_canvas_width = ele_video_canvas.width;
        let video_canvas_height = ele_video_canvas.height
        let points = [];// x1,y1,x2,y2,x3,y3,x4,y4
        for (let i = 0; i < polygon_lineArray.length; i++) {
            let line = polygon_lineArray[i];
            points.push((line.x/video_canvas_width).toFixed(4));
            points.push((line.y/video_canvas_height).toFixed(4));
        }
        let polygon = points.join(",");

        let data = {
            "controlCode":old_control_code,
            "algorithmCode":algorithmCode,
            "objectCode":objectCode,
            "pushStream":pushStream,
            "polygon":polygon,
            "minInterval":minInterval,
            "classThresh":classThresh,
            "overlapThresh":overlapThresh,
            "remark":remark
        }

        let handleUrl;
        if("add" === handle){
            handleUrl = "/api/postAddControl";
            let stream = streamCodeDict[streamCode];
            if (stream){
                data["streamApp"] = stream["app"]
                data["streamName"] = stream["name"]
                data["streamVideo"] = stream["video"]
                data["streamAudio"] = stream["audio"]
            }else{
                return;
            }
        }else if("edit" === handle){
            handleUrl = "/api/postEditControl";
        }else{
            return;
        }


        $.ajax({
           url: handleUrl,
           type: "post",
           async: true,
           data: data,
           dataType: "json",
           timeout: "3000",
           error: function () {
                myAlert("网络异常，请确定网络正常！","error");
           },
           success: function (res) {
               if(1000 === res.code){
                    myAlert(res.msg,"success");

               }else{
                    myAlert(res.msg,"error");
               }
           }
        });

    }

    window.onload = function (){
        getData();
    };


</script>
{% endblock javascripts %}

